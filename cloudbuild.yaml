steps:
- name: 'gcr.io/cloud-builders/gcloud'
  id: Configure git
  entrypoint: /bin/bash
  args:
  - '-c'
  - |
    git config --global init.defaultBranch main && \
    git config --global user.email "rohitmishra@google.com" && \
    git clone https://github.com/rmishgoog/kustomize-kubernetes-manifests

- name: 'gcr.io/cloud-builders/gcloud'
  id: Update manifest
  entrypoint: /bin/bash
  args:
  - '-c'
  - |
     cd kustomize-kubernetes-manifests && \
     export _CURR_TAG=`cut -d : -f 2 <<< "${_IMAGE_TAG}"` && \
     sed -i "s/PROJECT_ID/${PROJECT_ID}/g" overlays/development/product-listing-api/product-listing-api-dev-patch.yaml && \
     sed -i "s/SHORT_SHA/${_CURR_TAG}/g"  overlays/development/product-listing-api/product-listing-api-dev-patch.yaml

- name: 'gcr.io/cloud-builders/gcloud'
  id: Push manifest
  entrypoint: /bin/sh
  args:
  - '-c'
  - |
    cd kustomize-kubernetes-manifests && \
    set -x && \
    git config --global init.defaultBranch main && \
    git config --global user.email "rohitmishra@google.com" && \
    git add overlays/development/product-listing-api/product-listing-api-dev-patch.yaml && \
    git commit -m "Deploying the tag ${_IMAGE_TAG}" && \
    git push https://$$_GITHUB_TOKEN@github.com/rmishgoog/kustomize-kubernetes-manifests
  secretEnv: ['_GITHUB_TOKEN']

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/github-commits-cloud-build/versions/latest
      env: '_GITHUB_TOKEN'